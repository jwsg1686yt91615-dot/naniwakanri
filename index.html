<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <link rel="apple-touch-icon" href="naniwa_icon_v1.png">
  <link rel="apple-touch-icon" sizes="180x180" href="naniwa_icon_v1.png">
  <link rel="icon" type="image/png" href="naniwa_icon_v1.png">
  
  <title>ç‚¹å‘¼ã‚·ã‚¹ãƒ†ãƒ </title>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: #fff; font-family: sans-serif; overflow-x: hidden; }
    .container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding-bottom: 150px; }
    .header-image { width: 100%; height: auto; min-height: 50px; display: block; margin-bottom: 10px; background-color: #111; }
    select, input, textarea, .btn { display: block; width: 90%; margin: 10px auto; padding: 16px 12px; font-size: 18px !important; border-radius: 12px; border: 2px solid #333; background-color: #1a1a1a; color: #fff; box-sizing: border-box; -webkit-appearance: none; appearance: none; }
    select { height: 60px; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 20px; }
    textarea { height: 100px; resize: none; }
    .btn { font-size: 22px; font-weight: bold; border: none; cursor: pointer; text-align: center; justify-content: center; display: flex; align-items: center; text-decoration: none; }
    #submitBtn { background: linear-gradient(135deg, #ff0000 0%, #990000 100%); margin-top: 15px; width: 90%; }
    #submitBtn:disabled { background: #555 !important; opacity: 0.6; }
    #contactLink { background: #333; font-size: 16px; margin-top: 20px; border: 1px solid #555; width: 90%; }
    .label { width: 90%; text-align: left; font-size: 14px; color: #aaa; margin-top: 8px; font-weight: bold; }
    .timestamp { margin: 10px 0; font-size: 18px; color: #ccc; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    .confirm-box { width: 85%; background: #222; padding: 20px; border-radius: 20px; border: 2px solid red; }
    .btn-row { display: flex; gap: 10px; margin-top: 20px; }
    .btn-yes { background: red; flex: 1; padding: 15px; border-radius: 10px; color: #fff; font-weight: bold; border: none; font-size: 18px; }
    .btn-no { background: #555; flex: 1; padding: 15px; border-radius: 10px; color: #fff; border: none; font-size: 18px; }
  </style>
</head>
<body>
  <div class="container">
    <img class="header-image" src="https://raw.githubusercontent.com/jwsg1686yt91615-dot/naniwasan/main/head_logo.jpg" alt="HEAD LOGO">
    
    <div class="label">åº—èˆ—ã‚’é¸æŠ</div>
    <select id="store"><option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option></select>
    
    <div class="label">æ‹…å½“è€…ã‚’é¸æŠ</div>
    <select id="staff"><option value="" disabled selected>èª­ã¿è¾¼ã¿ä¸­...</option></select>
    
    <input id="staffOther" type="text" placeholder="åå‰ã‚’æ‰‹å…¥åŠ›" style="display:none;">
    
    <div class="label">é€£çµ¡å…ˆï¼ˆæ•°å­—ã®ã¿ï¼‰</div>
    <input id="phone" type="tel" placeholder="09012345678" inputmode="tel">
    
    <div class="label">å‚™è€ƒ</div>
    <textarea id="notes" placeholder="ä¼é”äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥"></textarea>
    
    <div class="timestamp" id="timestamp">--:--:--</div>
    
    <button id="submitBtn" class="btn">å‡ºåº«ã‚’è¨˜éŒ²ã™ã‚‹</button>
    <a href="tel:08040821925" id="contactLink" class="btn">ğŸ“ æ‹…å½“è€…ã«é€£çµ¡</a>
  </div>

  <div class="overlay" id="confirmOverlay">
    <div class="confirm-box">
      <div style="color:red; font-size:22px; font-weight:bold; text-align:center;">é€ä¿¡ç¢ºèª</div>
      <div id="confirmContent" style="margin: 20px 0; line-height: 1.6; font-size: 18px;"></div>
      <div class="btn-row">
        <button class="btn-no" onclick="document.getElementById('confirmOverlay').style.display='none'">ä¿®æ­£</button>
        <button class="btn-yes" id="finalSubmit">OK</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="resultOverlay">
    <div style="font-size:30px; color:red; font-weight:bold;">é€ä¿¡å®Œäº†</div>
  </div>

  <script>
    // ã€é‡è¦ã€‘ã‚ãªãŸã®GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyU69mcLTIQ8b5-PJMjC_g8pyhTSMooBt9TB1Y-59agVhHbUJ59soBsgOoPgThqffAM-Q/exec"; 

    let staffMaster = [];

    // æ™‚è¨ˆã®æ›´æ–°
    function updateTime() { document.getElementById("timestamp").textContent = new Date().toLocaleString('ja-JP'); }
    setInterval(updateTime, 1000); updateTime();

    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆfetchã‚’ä½¿ç”¨ï¼‰
    async function loadMasterData() {
      try {
        const response = await fetch(`${GAS_URL}?action=getMaster`);
        const data = await response.json();
        refreshUI(data);
      } catch (e) {
        console.error("ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—", e);
        alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function refreshUI(data) {
      if(!data || data.error) return;
      const sSel = document.getElementById("store"), fSel = document.getElementById("staff");
      sSel.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
      fSel.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
      if(data.stores) data.stores.forEach(s => sSel.add(new Option(s, s)));
      staffMaster = data.staffList || [];
      staffMaster.forEach(s => fSel.add(new Option(s.name, s.name)));
      fSel.add(new Option("ãã®ä»–(å…¥åŠ›)", "ãã®ä»–(å…¥åŠ›)"));
    }

    window.onload = loadMasterData;

    // æ‹…å½“è€…é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById("staff").addEventListener("change", e => {
      const other = document.getElementById("staffOther"), phoneInput = document.getElementById("phone");
      if (e.target.value === "ãã®ä»–(å…¥åŠ›)") {
        other.style.display = "block"; other.focus(); phoneInput.value = "";
      } else {
        other.style.display = "none";
        const info = staffMaster.find(s => s.name === e.target.value);
        phoneInput.value = (info && info.phone) ? info.phone.replace(/['\s-]/g, '') : "";
      }
    });

    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    document.getElementById("submitBtn").addEventListener("click", () => {
      const store = document.getElementById("store").value, phone = document.getElementById("phone").value.trim();
      let staff = document.getElementById("staff").value;
      if(staff === "ãã®ä»–(å…¥åŠ›)") staff = document.getElementById("staffOther").value.trim();
      if(!store || !staff || !phone) { alert("æœªå…¥åŠ›ãŒã‚ã‚Šã¾ã™"); return; }
      document.getElementById("confirmContent").innerHTML = `åº—èˆ—: ${store}<br>æ‹…å½“: ${staff}<br>é›»è©±: ${phone}`;
      document.getElementById("confirmOverlay").style.display = "flex";
    });

    // æœ€çµ‚é€ä¿¡ï¼ˆfetch POSTã‚’ä½¿ç”¨ï¼‰
    document.getElementById("finalSubmit").addEventListener("click", async function() {
      const btn = this; if(btn.disabled) return;
      btn.disabled = true; btn.innerHTML = "é€ä¿¡ä¸­...";
      
      const store = document.getElementById("store").value, 
            phone = document.getElementById("phone").value.trim(), 
            notes = document.getElementById("notes").value.trim();
      let staff = document.getElementById("staff").value;
      if(staff === "ãã®ä»–(å…¥åŠ›)") staff = document.getElementById("staffOther").value.trim();

      const record = { store, staff, phone, notes };

      try {
        const response = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify({ action: "submit", record: record })
        });
        const res = await response.json();

        if (res.success) {
          document.getElementById("confirmOverlay").style.display = "none";
          document.getElementById("resultOverlay").style.display = "flex";
          setTimeout(() => {
            document.getElementById("resultOverlay").style.display = "none";
            document.getElementById("staffOther").value = ""; 
            document.getElementById("phone").value = ""; 
            document.getElementById("notes").value = "";
            document.getElementById("store").selectedIndex = 0; 
            document.getElementById("staff").selectedIndex = 0;
            if(res.newData) refreshUI(res.newData);
            btn.disabled = false; btn.innerHTML = "OK";
          }, 2000);
        } else {
          alert("ã‚¨ãƒ©ãƒ¼: " + res.error);
          btn.disabled = false; btn.innerHTML = "OK";
        }
      } catch (e) {
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        btn.disabled = false; btn.innerHTML = "OK";
      }
    });
  </script>
</body>
</html>
