<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* CSSは変更なしのため省略（以前のコードのものをそのまま使ってください） */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; color: #fff; font-family: sans-serif; overflow-x: hidden; }
    .container { width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; padding-bottom: 150px; }
    .header-image { width: 100%; height: auto; min-height: 50px; display: block; margin-bottom: 10px; background-color: #111; }
    select, input, textarea, .btn { display: block; width: 90%; margin: 10px auto; padding: 16px 12px; font-size: 18px !important; border-radius: 12px; border: 2px solid #333; background-color: #1a1a1a; color: #fff; box-sizing: border-box; -webkit-appearance: none; appearance: none; }
    select { height: 60px; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 20px; }
    textarea { height: 100px; resize: none; }
    .btn { font-size: 22px; font-weight: bold; border: none; cursor: pointer; text-align: center; justify-content: center; display: flex; align-items: center; }
    #submitBtn { background: linear-gradient(135deg, #ff0000 0%, #990000 100%); margin-top: 15px; }
    #submitBtn:disabled { background: #555 !important; opacity: 0.6; }
    .label { width: 90%; text-align: left; font-size: 14px; color: #aaa; margin-top: 8px; font-weight: bold; }
    .timestamp { margin: 10px 0; font-size: 18px; color: #ccc; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    .confirm-box { width: 85%; background: #222; padding: 20px; border-radius: 20px; border: 2px solid red; }
    .btn-row { display: flex; gap: 10px; margin-top: 20px; }
    .btn-yes { background: red; flex: 1; padding: 15px; border-radius: 10px; color: #fff; font-weight: bold; border: none; }
    .btn-no { background: #555; flex: 1; padding: 15px; border-radius: 10px; color: #fff; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <img class="header-image" src="https://raw.githubusercontent.com/jwsg1686yt91615-dot/naniwasan/main/head_logo.jpg">
    <div class="label">店舗を選択</div>
    <select id="store"><option value="" disabled selected>読み込み中...</option></select>
    <div class="label">担当者を選択</div>
    <select id="staff"><option value="" disabled selected>読み込み中...</option></select>
    <input id="staffOther" type="text" placeholder="名前を手入力" style="display:none;">
    <div class="label">連絡先（数字のみ）</div>
    <input id="phone" type="tel" placeholder="09012345678" inputmode="tel">
    <div class="label">備考</div>
    <textarea id="notes" placeholder="伝達事項があれば記入"></textarea>
    <div class="timestamp" id="timestamp">--:--:--</div>
    <button id="submitBtn" class="btn">出庫を記録する</button>
  </div>

  <div class="overlay" id="confirmOverlay"><div class="confirm-box">
    <div style="color:red; font-size:22px; font-weight:bold; text-align:center;">送信確認</div>
    <div id="confirmContent" style="margin: 20px 0; line-height: 1.6; font-size: 18px;"></div>
    <div class="btn-row">
      <button class="btn-no" onclick="document.getElementById('confirmOverlay').style.display='none'">修正</button>
      <button class="btn-yes" id="finalSubmit">OK</button>
    </div>
  </div></div>
  <div class="overlay" id="resultOverlay"><div style="font-size:30px; color:red; font-weight:bold;">送信完了</div></div>

  <script>
    // ★ここにあなたのGASウェブアプリURLを貼り付けてください
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyU69mcLTIQ8b5-PJMjC_g8pyhTSMooBt9TB1Y-59agVhHbUJ59soBsgOoPgThqffAM-Q/exec";

    let staffMaster = [];

    // GAS呼び出し用共通関数
    async function callGas(method, params = {}) {
      const response = await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({ method: method, ...params })
      });
      return await response.json();
    }

    function updateTime() { document.getElementById("timestamp").textContent = new Date().toLocaleString('ja-JP'); }
    setInterval(updateTime, 1000); updateTime();

    function refreshUI(data) {
      if(!data || data.error) return;
      const sSel = document.getElementById("store"), fSel = document.getElementById("staff");
      const currentStore = sSel.value;
      if (sSel.options.length <= 1) {
        sSel.innerHTML = '<option value="" disabled selected>選択してください</option>';
        if(data.stores) data.stores.forEach(s => sSel.add(new Option(s, s)));
        if(currentStore) sSel.value = currentStore;
      }
      fSel.innerHTML = '<option value="" disabled selected>選択してください</option>';
      staffMaster = data.staffList || [];
      staffMaster.forEach(s => fSel.add(new Option(s.name, s.name)));
      fSel.add(new Option("その他(入力)", "その他(入力)"));
    }

    window.onload = async () => {
      const data = await callGas("getMasterData");
      refreshUI(data);
    };

    document.getElementById("staff").addEventListener("change", e => {
      const other = document.getElementById("staffOther"), phoneInput = document.getElementById("phone");
      if (e.target.value === "その他(入力)") {
        other.style.display = "block"; other.focus(); phoneInput.value = "";
      } else {
        other.style.display = "none";
        const info = staffMaster.find(s => s.name === e.target.value);
        phoneInput.value = (info && info.phone) ? info.phone.replace(/['\s-]/g, '') : "";
      }
    });

    document.getElementById("submitBtn").addEventListener("click", () => {
      const store = document.getElementById("store").value;
      const phone = document.getElementById("phone").value.trim();
      let staff = document.getElementById("staff").value;
      if(staff === "その他(入力)") staff = document.getElementById("staffOther").value.trim();
      if(!store || !staff || !phone) { alert("未入力があります"); return; }
      document.getElementById("confirmContent").innerHTML = `店舗: ${store}<br>担当: ${staff}<br>電話: ${phone}`;
      document.getElementById("confirmOverlay").style.display = "flex";
    });

    document.getElementById("finalSubmit").addEventListener("click", async function() {
      const btn = this; 
      if(btn.disabled || btn.innerHTML === "送信中...") return;
      btn.disabled = true; btn.innerHTML = "送信中...";
      
      const store = document.getElementById("store").value;
      const phone = document.getElementById("phone").value.trim();
      const notes = document.getElementById("notes").value.trim();
      let staff = document.getElementById("staff").value;
      if(staff === "その他(入力)") staff = document.getElementById("staffOther").value.trim();
      
      try {
        const res = await callGas("submitData", { data: {store, staff, phone, notes} });
        if (res.success) {
          document.getElementById("confirmOverlay").style.display = "none";
          document.getElementById("resultOverlay").style.display = "flex";
          setTimeout(() => {
            document.getElementById("resultOverlay").style.display = "none";
            document.getElementById("staffOther").value = ""; 
            document.getElementById("staffOther").style.display = "none";
            document.getElementById("phone").value = ""; 
            document.getElementById("notes").value = "";
            document.getElementById("staff").selectedIndex = 0;
            if(res.newData) refreshUI(res.newData);
            btn.disabled = false; btn.innerHTML = "OK";
          }, 2000);
        } else {
          alert("エラー: " + res.error);
          btn.disabled = false; btn.innerHTML = "OK";
        }
      } catch (e) {
        alert("通信エラーが発生しました");
        btn.disabled = false; btn.innerHTML = "OK";
      }
    });
  </script>
</body>
</html>
